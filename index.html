<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AR家具配置アプリ (A-Frame)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #1A202C;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
        }
        canvas { display: block; }
        #title-container {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            width: 90%;
        }
        #title-container h1 {
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1.4;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        #ARButton {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 9999px !important;
            font-size: 16px !important;
            font-weight: bold !important;
            padding: 14px 24px !important;
            min-width: 220px !important;
            box-shadow: none !important;
            opacity: 1 !important;
            position: absolute !important;
            bottom: 15% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 100 !important;
            white-space: nowrap !important;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
        }
        #instruction-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 20px 30px;
            border-radius: 15px;
            line-height: 1.7;
            display: none;
            pointer-events: none;
            min-width: 260px;
            box-sizing: border-box;
        }

        #bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 220px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 80px;
            box-sizing: border-box;
        }

        #transform-controls, #decision-controls {
            display: none;
            align-items: center;
            pointer-events: auto;
            width: 90%;
            max-width: 400px;
            justify-content: center;
        }

        #transform-controls {
            gap: 15px;
            margin-bottom: 20px;
        }
        #decision-controls {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 9999px;
            overflow: hidden;
            width: auto;
        }

        #scale-slider-container {
            width: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 48px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 9999px;
            padding: 0 10px;
        }
        .slider-icon {
            font-size: 24px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            padding: 0 8px;
        }
        #slider-track {
            width: 100%;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            position: relative;
        }
        #slider-handle {
            width: 32px;
            height: 32px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease;
        }
        .rotation-button-group {
            display: flex;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 9999px;
            overflow: hidden;
        }
        .group-button {
            background: none;
            border: none;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        .group-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .group-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #delete-button, #confirm-button {
            padding: 16px 28px;
        }
        #delete-button {
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }
        #rotate-right-button {
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .rotation-button-group .group-button svg {
            transform: rotate(180deg);
        }

        #add-button, #edit-button {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            pointer-events: auto;
        }
        .circle-button {
            width: 64px;
            height: 64px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s ease, background-color 0.2s ease;
            pointer-events: auto;
            flex-shrink: 0;
            user-select: none;
        }
        #mode-switch-button {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            padding: 5px;
            font-size: 15px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            gap: 5px;
            pointer-events: auto;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }
        .mode-label {
            transition: all 0.3s ease-in-out;
            padding: 5px 15px;
            border-radius: 9999px;
            font-weight: normal;
            color: #a0aec0;
            background-color: transparent;
        }
        .mode-label.active {
            font-weight: bold;
            color: #1A202C;
            background-color: white;
        }

        #top-left-controls {
            position: absolute;
            top: 40px;
            left: 20px;
            z-index: 11;
        }
        #top-right-controls {
            position: absolute;
            top: 40px;
            right: 20px;
            z-index: 11;
        }
        #help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            pointer-events: auto;
        }
        #help-content-container {
            background-color: rgba(45, 55, 72, 0.85);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            height: 580px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        #close-help-button {
            position: absolute;
            bottom: -70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 28px;
            line-height: 48px;
            text-align: center;
            z-index: 15;
        }
        .help-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            flex-shrink: 0;
        }
        .help-tab-button {
            flex-grow: 1;
            padding: 10px;
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #A0AECB;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .help-tab-button.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .help-page-content {
            overflow-y: auto;
            padding-right: 10px;
            flex: 1;
            min-height: 0;
        }
        .help-page {
            display: none;
        }
        .help-page.active {
            display: block;
        }
        .help-section {
            margin-bottom: 25px;
        }
        .help-section:last-child {
            margin-bottom: 0;
        }
        .help-section h3 {
            margin: 0 0 15px 5px;
            color: #A0AECB;
            font-size: 1rem;
        }
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
        }
        .help-card {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
        }
        .help-card .icon-container {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #CBD5E0;
            margin-bottom: 5px;
        }
        .help-card .icon-container svg {
            width: 100%;
            height: 100%;
        }
        .help-card h4 {
            margin: 0;
            font-size: 0.9rem;
            color: white;
            line-height: 1.3;
        }
        .help-card p {
            margin: 0;
            font-size: 0.75rem;
            color: #A0AECB;
            line-height: 1.4;
        }
        .gesture-svg {
            stroke: #CBD5E0;
            fill: none;
        }
        .gesture-svg .finger {
            fill: #CBD5E0;
            stroke: none;
        }
        .gesture-svg .arrow {
            fill: #CBD5E0;
        }

        .dialog-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
            pointer-events: auto;
        }
        .dialog-box {
            background-color: rgba(45, 55, 72, 0.9);
            padding: 25px 35px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .dialog-box p {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .dialog-buttons button {
            border: none;
            border-radius: 9999px;
            padding: 10px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #confirm-delete-no {
            background-color: rgba(255,255,255,0.2);
            color: white;
        }
        #confirm-delete-yes {
            background-color: #E53E3E;
            color: white;
        }

        #furniture-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 250;
            padding-bottom: 15vh;
            box-sizing: border-box;
            transition: bottom 0.3s ease-out;
            bottom: 0;
        }

        #furniture-modal-inner {
            max-width: 380px;
            width: 90%;
            height: 35vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
            position: relative;
            background-color: rgba(45, 55, 72, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #modal-header {
            padding: 15px 20px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: none;
            flex-shrink: 0;
            position: relative;
        }
        #modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
        }
        #close-modal-button {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 28px;
            line-height: 48px;
            text-align: center;
        }

        /* 検索バーのスタイル */
        #search-container {
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        #search-input {
            width: calc(100% - 40px);
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
            padding-left: 40px;
        }
        #search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .search-icon {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }
        .clear-search-button {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            display: none;
        }

        /* カテゴリタブのスタイル */
        #category-tabs {
            display: flex;
            justify-content: flex-start;
            gap: 8px;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
            border-radius: 0 0 0 0;
        }

        .category-tab-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 18px;
            border-radius: 9999px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s ease, color 0.2s ease;
            flex-shrink: 0;
        }

        .category-tab-button.active {
            background-color: white;
            color: #1A202C;
        }

        .category-tab-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* 家具グリッドのスタイル調整（縦スクロール対応） */
        #furniture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
            box-sizing: border-box;
        }

        .grid-item {
            cursor: pointer;
            text-align: center;
            background-color: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 8px 5px;
            transition: background-color 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            width: 90px;
            height: 90px;
        }
        .grid-item:hover {
            background-color: rgba(255,255,255,0.15);
        }
        .grid-item img {
            display: block;
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px;
        }
        .grid-item p {
            margin: 0;
            font-size: 0.75rem;
            font-weight: normal;
            color: #E2E8F0;
            white-space: normal;
            word-break: break-word;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* キーボード表示時のモーダル位置調整用クラス */
        .modal-above-keyboard {
            padding-bottom: 0 !important;
            height: 100%;
            bottom: var(--keyboard-height, 0px);
            align-items: flex-end;
        }
        .modal-above-keyboard #furniture-modal-inner {
            border-radius: 20px 20px 0 0;
        }
    </style>
</head>
<body>
    <div id="title-container">
        <h1>AR家具配置<br>シミュレーション</h1>
        <button id="customARButton">ARを開始する</button>
    </div>

    <div id="overlay">

        <div id="help-modal">
            <div id="help-content-container">
                <button id="close-help-button">&times;</button>
                <div class="help-tabs">
                    <button class="help-tab-button active" data-tab="page1">基本操作</button>
                    <button class="help-tab-button" data-tab="page2">家具の操作</button>
                </div>
                <div class="help-page-content">
                    <div class="help-page active" id="page1">
                        <div class="help-section">
                            <h3>画面モード</h3>
                            <div class="help-grid">
                                <div class="help-card">
                                    <div class="icon-container">
                                        <svg viewBox="0 0 100 40"><rect x="1" y="1" width="98" height="38" rx="19" fill="rgba(0,0,0,0.5)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/><rect x="3" y="3" width="46" height="34" rx="17" fill="white"/><text x="26" y="26" font-family="sans-serif" font-size="12" fill="black" font-weight="bold" text-anchor="middle">編集</text><text x="72" y="26" font-family="sans-serif" font-size="12" fill="#a0aec0" text-anchor="middle">鑑賞</text></svg>
                                    </div>
                                    <h4>モード切替</h4>
                                    <p>「編集」「鑑賞」を切り替えます。</p>
                                </div>
                                <div class="help-card">
                                    <div class="icon-container">
                                        <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3-3-3-3m0 0 3-3m-3 3h12" /></svg>
                                    </div>
                                    <h4>AR終了</h4>
                                    <p>AR体験を終了し、タイトル画面に戻ります。</p>
                                </div>
                            </div>
                        </div>
                        <div class="help-section">
                            <h3>編集モードの基本</h3>
                            <div class="help-grid">
                                <div class="help-card">
                                    <div class="icon-container">
                                        <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                    </div>
                                    <h4>家具の追加</h4>
                                    <p>「+」ボタンから配置したい家具を選択します。</p>
                                </div>
                                <div class="help-card">
                                    <div class="icon-container">
                                        <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
                                    </div>
                                    <h4>家具の編集</h4>
                                    <p>家具を狙うと出るボタンで再選択できます。</p>
                                </div>
                                <div class="help-card">
                                    <div class="icon-container">
                                        <svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                                    </div>
                                    <h4>一覧に戻る</h4>
                                    <p>家具選択画面に戻ります。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="help-page" id="page2">
                            <div class="help-section">
                                <h3>配置場所の確認</h3>
                                <div class="help-grid">
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><circle cx="12" cy="12" r="7.5" /></svg>
                                        </div>
                                        <h4>配置できます</h4>
                                        <p>地面に輪が表示されている場所に置けます。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container" style="color: #f56565;">
                                            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
                                        </div>
                                        <h4>配置できません</h4>
                                        <p>❌印の場所には置けません。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="help-section">
                                <h3>ジェスチャー操作</h3>
                                <div class="help-grid">
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg viewBox="0 0 48 48" class="gesture-svg">
                                                <defs><path id="arc-path" d="M8,34 A16,16 0 0,1 40,34" fill="none"/></defs>
                                                <path d="M12,12 h24 v24 h-24z" stroke-width="1" opacity="0.5"/>
                                                <use href="#arc-path" stroke-dasharray="4 4" stroke-width="1.5" opacity="0.7"/>
                                                <circle cx="24" cy="23" r="5" class="finger" />
                                                <path d="M7 32 L10 35 L13 32 Z" class="arrow"/>
                                            </svg>
                                        </div>
                                        <h4>回転</h4>
                                        <p>1本指で家具を左右にドラッグして回します。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg viewBox="0 0 48 48" class="gesture-svg">
                                                <circle cx="18" cy="30" r="5" class="finger"/>
                                                <circle cx="30" cy="18" r="5" class="finger"/>
                                                <path d="M21,27 l-4,-4" stroke-width="1.5" stroke-dasharray="3 3"/>
                                                <path d="M15,21 l-3,-1 l2,3" class="arrow" />
                                                <path d="M27,21 l4,4" stroke-width="1.5" stroke-dasharray="3 3"/>
                                                <path d="M33,27 l3,1 l-2,-3" class="arrow"/>
                                            </svg>
                                        </div>
                                        <h4>拡大・縮小</h4>
                                        <p>2本指で広げたりつまんでサイズ変更。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg viewBox="0 0 48 48" class="gesture-svg">
                                                <path d="M14,18 h20 v12 h-20z" stroke-width="1" opacity="0.5"/>
                                                <circle cx="24" cy="24" r="5" class="finger"/>
                                                <circle cx="24" cy="24" r="9" stroke-width="1.5" stroke-dasharray="2 4" opacity="0.9" />
                                            </svg>
                                        </div>
                                        <h4>長押しで削除</h4>
                                        <p>家具を長押しすると削除の確認ができます。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="help-section">
                                <h3>ボタン操作</h3>
                                <div class="help-grid">
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg viewBox="0 0 48 48" stroke="#CBD5E0" fill="none">
                                                <text x="2" y="32" font-family="sans-serif" font-size="20" font-weight="bold" stroke="none" fill="#CBD5E0">-</text>
                                                <rect x="13" y="22" width="22" height="4" rx="2" stroke="none" fill="rgba(255,255,255,0.4)"></rect>
                                                <circle cx="24" cy="24" r="6" stroke-width="2" fill="white"></circle>
                                                <text x="36" y="32" font-family="sans-serif" font-size="20" font-weight="bold" stroke="none" fill="#CBD5E0">+</text>
                                            </svg>
                                        </div>
                                        <h4>サイズ変更</h4>
                                        <p>スライダーを動かして家具の大きさを変更します。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="transform: rotate(180deg);">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 1 0 12h3" />
                                            </svg>
                                        </div>
                                        <h4>回転</h4>
                                        <p>タップで45度、長押しで連続回転します。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                                        </div>
                                        <h4>配置の確定</h4>
                                        <p>家具の位置や向き、大きさを決定します。</p>
                                    </div>
                                    <div class="help-card">
                                        <div class="icon-container">
                                            <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                        </div>
                                        <h4>削除</h4>
                                        <p>選択中の家具をシーンから削除します。</p>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="instruction-text">
            <span style="font-size: 1.25em; font-weight: bold;">床を認識中<span id="loading-dots"></span></span><br><br>
            カメラをゆっくりと<br>床に向けて<br>動かしてください
        </div>

        <button id="mode-switch-button">
            <span id="edit-mode-label" class="mode-label">編集モード</span>
            <span id="view-mode-label" class="mode-label">鑑賞モード</span>
        </button>

        <div id="top-left-controls">
            <button id="help-button" class="circle-button" style="display: none; width: 56px; height: 56px;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 28px; height: 28px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </button>
        </div>
        <div id="top-right-controls">
            <button id="exit-ar-button" class="circle-button" style="display: none; width: 56px; height: 56px;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 28px; height: 28px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3-3-3-3m0 0 3-3m-3 3h12" />
                </svg>
            </button>
        </div>

        <div id="bottom-bar">
            <button id="add-button" class="circle-button"></button>
            <button id="edit-button" class="circle-button"></button>

            <div id="transform-controls">
                <div id="scale-slider-container">
                    <span class="slider-icon">-</span>
                    <div id="slider-track">
                        <div id="slider-handle"></div>
                    </div>
                    <span class="slider-icon">+</span>
                </div>
                <div class="rotation-button-group">
                    <button id="rotate-left-button" class="group-button"></button>
                    <button id="rotate-right-button" class="group-button"></button>
                </div>
            </div>
            <div id="decision-controls">
                <button id="delete-button" class="group-button"></button>
                <button id="confirm-button" class="group-button"></button>
            </div>
        </div>

        <div id="confirm-dialog" class="dialog-container">
            <div class="dialog-box">
                <p>この家具を削除しますか？</p>
                <div class="dialog-buttons">
                    <button id="confirm-delete-no">いいえ</button>
                    <button id="confirm-delete-yes">はい</button>
                </div>
            </div>
        </div>

        <div id="furniture-modal">
            <div id="furniture-modal-inner">
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="家具を検索...">
                    <span class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                    </span>
                    <button class="clear-search-button" id="clear-search-button">&times;</button>
                    <ul id="search-suggestions" style="
                        position: absolute;
                        top: calc(100% + 5px);
                        left: 20px;
                        right: 20px;
                        background-color: rgba(45, 55, 72, 0.95);
                        border-radius: 8px;
                        list-style: none;
                        padding: 0;
                        margin: 0;
                        max-height: 150px;
                        overflow-y: auto;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                        display: none;
                        z-index: 10;
                    "></ul>
                </div>
                <div id="category-tabs">
                </div>
                <div id="furniture-grid">
                </div>
                <button id="close-modal-button">&times;</button>
            </div>
        </div>

    </div>

    <a-scene
        webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; domOverlay: #overlay;"
        ar-hit-test-manager
        furniture-manager
        cursor="rayOrigin: mouse; fuse: false;"
        raycaster="objects: .collidable; far: 10;"
        gltf-model-progress>
        <a-camera id="camera" position="0 1.6 0" look-controls>
            <a-entity id="reticle"
                geometry="primitive: ring; radiusOuter: 0.2; radiusInner: 0.15;"
                material="color: white; shader: flat; transparent: true; opacity: 0.8;"
                position="0 0 -3"
                rotation="-90 0 0"
                visible="false">
            </a-entity>
            <a-image id="cross-mark"
                src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+PGNpcmNsZSBjeD0iMTI4IiBjeT0iMTI4IiByPSIxMjgiIGZpbGw9InJnYmEoMjA0LCAwLCAwLCAwLjgpIi8+PHBhdGggZD0iTTE5Mi4xNDIgNjMuODU4TDYzLjg1OCAxOTIuMTQyTTYzLjg1OCAzMi44NTdMMTkyLjE0MiAxMjYuMTQzIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4="
                position="0 0 -3"
                scale="0.5 0.5 1"
                visible="false"></a-image>
        </a-camera>

        <a-assets timeout="60000">
            <a-asset-item id="chair-model" src="chair.glb"></a-asset-item>
            <a-asset-item id="bookshelf-model" src="bookshelf.glb"></a-asset-item>
            <a-asset-item id="stand-model" src="stand.glb"></a-asset-item>
            <a-asset-item id="dining-table-model" src="dining_table.glb"></a-asset-item>
            <a-asset-item id="sofa-model" src="sofa.glb"></a-asset-item>
            <a-asset-item id="floor-lamp-model" src="floor_lamp.glb"></a-asset-item>
            <a-asset-item id="desk-model" src="desk.glb"></a-asset-item>
            <a-asset-item id="side-table-model" src="side_table.glb"></a-asset-item>
            <a-asset-item id="single-bed-model" src="single_bed.glb"></a-asset-item>
            <a-asset-item id="tv-board-model" src="tv_board.glb"></a-asset-item>
            <a-asset-item id="low-table-model" src="low_table.glb"></a-asset-item>
            <a-asset-item id="coat-hanger-model" src="coat_hanger.glb"></a-asset-item>
        </a-assets>

    </a-scene>

    <script>
        // DOM要素の取得
        const titleContainer = document.getElementById('title-container');
        const instructionText = document.getElementById('instruction-text');
        const loadingDots = document.getElementById('loading-dots');
        const modeSwitchButton = document.getElementById('mode-switch-button');
        const editModeLabel = document.getElementById('edit-mode-label');
        const viewModeLabel = document.getElementById('view-mode-label');
        const addButton = document.getElementById('add-button');
        const editButton = document.getElementById('edit-button');
        const transformControls = document.getElementById('transform-controls');
        const decisionControls = document.getElementById('decision-controls');
        const confirmButton = document.getElementById('confirm-button');
        const deleteButton = document.getElementById('delete-button');
        const rotateLeftButton = document.getElementById('rotate-left-button');
        const rotateRightButton = document.getElementById('rotate-right-button');
        const scaleSliderContainer = document.getElementById('scale-slider-container');
        const sliderTrack = document.getElementById('slider-track');
        const sliderHandle = document.getElementById('slider-handle');
        const helpButton = document.getElementById('help-button');
        const exitArButton = document.getElementById('exit-ar-button');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');
        const tabButtons = document.querySelectorAll('.help-tab-button');
        const helpPages = document.querySelectorAll('.help-page');
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmDeleteYes = document.getElementById('confirm-delete-yes');
        const confirmDeleteNo = document.getElementById('confirm-delete-no');
        const furnitureModal = document.getElementById('furniture-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const furnitureGrid = document.getElementById('furniture-grid');
        const searchInput = document.getElementById('search-input');
        const clearSearchButton = document.getElementById('clear-search-button');
        const modalContent = document.getElementById('furniture-modal-inner');
        
        // UI関連の変数
        let appState = 'INITIALIZING'; // INITIALIZING, IDLE, PLACING, EDITING
        let isEditMode = true; // true: 編集モード, false: 鑑賞モード
        let isFloorDetected = false;
        let dotAnimationTimer = null;
        let objectPendingDeletion = null;
        
        // 家具データ（カテゴリとサムネイルパスを追加）
        const furnitureData = [
            { name: 'イス', file: 'chair.glb', height: 0.79, category: 'チェア', thumbnail: 'thumbnails/chair_thumb.png' },
            { name: '本棚', file: 'bookshelf.glb', height: 1.8, category: '収納', thumbnail: 'thumbnails/bookshelf_thumb.png' },
            { name: '脚立', file: 'stand.glb', height: 1.2, category: 'その他', thumbnail: 'thumbnails/stand_thumb.png' },
           /* { name: 'ダイニングテーブル', file: 'dining_table.glb', height: 0.75, category: 'テーブル', thumbnail: 'thumbnails/dining_table_thumb.png' },
            { name: 'ソファ', file: 'sofa.glb', height: 0.7, category: 'ソファ', thumbnail: 'thumbnails/sofa_thumb.png' },
            { name: 'フロアランプ', file: 'floor_lamp.glb', height: 1.5, category: '照明', thumbnail: 'thumbnails/floor_lamp_thumb.png' },
            { name: 'デスク', file: 'desk.glb', height: 0.72, category: 'テーブル', thumbnail: 'thumbnails/desk_thumb.png' },
            { name: 'サイドテーブル', file: 'side_table.glb', height: 0.5, category: 'テーブル', thumbnail: 'thumbnails/side_table_thumb.png' },
            { name: 'シングルベッド', file: 'single_bed.glb', height: 0.6, category: 'ベッド', thumbnail: 'thumbnails/single_bed_thumb.png' },
            { name: 'テレビボード', file: 'tv_board.glb', height: 0.4, category: '収納', thumbnail: 'thumbnails/tv_board_thumb.png' },
            { name: 'ローテーブル', file: 'low_table.glb', height: 0.35, category: 'テーブル', thumbnail: 'thumbnails/low_table_thumb.png' },
            { name: 'コートハンガー', file: 'coat_hanger.glb', height: 1.7, category: 'その他', thumbnail: 'thumbnails/coat_hanger_thumb.png' }, */
        ];
        let allCategories = [];
        let currentCategoryIndex = 0;
        let selectedFurnitureData = null; // 現在選択中の家具データ（プレビュー用）
        
        // --- A-Frame コンポーネント定義 ---
        
        // ARヒットテストを管理するコンポーネント
        AFRAME.registerComponent('ar-hit-test-manager', {
            init: function () {
                this.reticle = document.getElementById('reticle');
                this.crossMark = document.getElementById('cross-mark');
                this.camera = document.getElementById('camera');
                this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
                this.el.sceneEl.addEventListener('exit-vr', this.onExitVR.bind(this));
                this.hitTestSource = null;
                this.hitTestSourceRequested = false;
                this.isFloorDetected = false;
                this.floorY = null;
        
                // レティクルとクロスマークの初期状態設定
                this.reticle.setAttribute('visible', 'false');
                this.crossMark.setAttribute('visible', 'false');
        
                // アプリの状態に応じてレティクルとクロスマークの表示を更新するイベントリスナー
                this.el.sceneEl.addEventListener('app-state-changed', (event) => {
                    appState = event.detail.state;
                    this.updateReticleAndCrossMarkVisibility();
                });
                this.el.sceneEl.addEventListener('floor-detected', (event) => {
                    this.isFloorDetected = event.detail.isDetected;
                    this.floorY = event.detail.floorY;
                    this.updateReticleAndCrossMarkVisibility();
                });
                this.el.sceneEl.addEventListener('is-edit-mode-changed', (event) => {
                    isEditMode = event.detail.isEditMode;
                    this.updateReticleAndCrossMarkVisibility();
                });
            },
        
            onEnterVR: function () {
                const session = this.el.sceneEl.renderer.xr.getSession();
                if (session && !this.hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((referenceSpace) => {
                        session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                            this.hitTestSource = source;
                        });
                    });
                    this.hitTestSourceRequested = true;
                    session.addEventListener('end', () => {
                        this.hitTestSourceRequested = false;
                        this.hitTestSource = null;
                        this.isFloorDetected = false;
                        this.floorY = null;
                        this.reticle.setAttribute('visible', 'false');
                        this.crossMark.setAttribute('visible', 'false');
                        this.el.sceneEl.emit('floor-detected', { isDetected: false, floorY: null });
                    });
                    this.el.sceneEl.emit('app-state-changed', { state: 'IDLE' });
                }
            },
        
            onExitVR: function () {
                this.reticle.setAttribute('visible', 'false');
                this.crossMark.setAttribute('visible', 'false');
                instructionText.style.display = 'none';
                stopDotAnimation();
            },
        
            tick: function () {
                if (!this.el.sceneEl.is('ar-mode') || !this.hitTestSource) {
                    this.reticle.setAttribute('visible', 'false');
                    this.crossMark.setAttribute('visible', 'false');
                    if (!this.isFloorDetected && appState === 'INITIALIZING') { // AR開始時のみ
                        instructionText.style.display = 'block';
                        startDotAnimation();
                    }
                    return;
                }
        
                const frame = this.el.sceneEl.renderer.xr.getFrame();
                const referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
                const hitTestResults = frame.getHitTestResults(this.hitTestSource);
        
                let isCurrentlyPlaceable = false;
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const hitPose = hit.getPose(referenceSpace);
                    const hitPosition = hitPose.transform.position;
        
                    // 床面が初めて検出された場合、Y座標を固定
                    if (this.floorY === null) {
                        this.floorY = hitPosition.y;
                        this.el.sceneEl.emit('floor-detected', { isDetected: true, floorY: this.floorY });
                    }
        
                    const Y_TOLERANCE = 0.2; // 20cmの許容範囲
                    const isOnFloor = Math.abs(hitPosition.y - this.floorY) < Y_TOLERANCE;
        
                    // 衝突判定 (Three.jsのRaycasterをA-Frameで使う場合の例)
                    const tempVec2 = new AFRAME.THREE.Vector2(0, 0); // 画面中央
                    const raycaster = this.el.sceneEl.systems.raycaster.unprojectedRaycaster; // A-Frameの内部Raycaster
                    this.camera.object3D.updateMatrixWorld();
                    raycaster.setFromCamera(tempVec2, this.camera.object3D);
        
                    let isColliding = false;
                    // placedObjectsはfurniture-managerで管理されているので、そちらから取得
                    const furnitureManager = this.el.sceneEl.components['furniture-manager'];
                    if (furnitureManager && furnitureManager.placedObjects) {
                        const activeObject = furnitureManager.previewObject || furnitureManager.selectedObject;
                        for (const placedObj of furnitureManager.placedObjects) {
                            if (placedObj !== activeObject && placedObj.object3D) { // activeObject自身とは衝突しない
                                const placedObjBox = new AFRAME.THREE.Box3().setFromObject(placedObj.object3D);
                                if (activeObject && activeObject.object3D) { // activeObjectも存在することを確認
                                    const activeObjectBox = new AFRAME.THREE.Box3().setFromObject(activeObject.object3D);
                                    if (activeObjectBox.intersectsBox(placedObjBox)) {
                                        isColliding = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
        
                    isCurrentlyPlaceable = isOnFloor && !isColliding;
        
                    // レティクルとクロスマークの位置を更新
                    const position = hitPose.transform.position;
                    const orientation = hitPose.transform.orientation;
        
                    if (appState === 'PLACING' || appState === 'EDITING') {
                        this.reticle.setAttribute('visible', isCurrentlyPlaceable && isEditMode);
                        this.crossMark.setAttribute('visible', !isCurrentlyPlaceable && isEditMode);
        
                        // レティクルとプレビュー/選択オブジェクトの同期
                        const targetObject = furnitureManager.previewObject || furnitureManager.selectedObject;
                        if (targetObject && targetObject.object3D) {
                            targetObject.object3D.position.set(position.x, position.y, position.z);
                            targetObject.object3D.quaternion.set(orientation.x, orientation.y, orientation.z, orientation.w);
                            // 配置対象がプレビューオブジェクトの場合、高さオフセットを適用
                            if (furnitureManager.previewObject && furnitureManager.previewObject.object3D.userData.centerOffset) {
                                targetObject.object3D.position.y -= furnitureManager.previewObject.object3D.userData.centerOffset.y;
                            }
                        }
        
                        if (this.crossMark.getAttribute('visible')) {
                            // クロスマークの位置とスケールを家具に合わせて調整
                            if (targetObject && targetObject.object3D) {
                                const box = new AFRAME.THREE.Box3().setFromObject(targetObject.object3D);
                                const size = box.getSize(new AFRAME.THREE.Vector3());
                                this.crossMark.setAttribute('position', {
                                    x: targetObject.object3D.position.x,
                                    y: targetObject.object3D.position.y + size.y / 2 + 0.01, // 家具の底面より少し上
                                    z: targetObject.object3D.position.z
                                });
                                const scaleValue = Math.max(size.x, size.z) * targetObject.object3D.scale.x * 0.2; // ❌マークの大きさを調整
                                this.crossMark.setAttribute('scale', `${scaleValue} ${scaleValue} 1`);
                                // クロスマークをカメラの方向に向ける
                                this.crossMark.object3D.quaternion.copy(this.camera.object3D.quaternion);
                            }
                        }
                        this.el.sceneEl.emit('placeability-changed', { isPlaceable: isCurrentlyPlaceable });
                    } else { // IDLEモードの場合
                        this.reticle.setAttribute('visible', 'false');
                        this.crossMark.setAttribute('visible', 'false');
                    }
        
                    if (instructionText.style.display !== 'none' && this.isFloorDetected) {
                        instructionText.style.display = 'none';
                        stopDotAnimation();
                    }
                } else {
                    this.reticle.setAttribute('visible', 'false');
                    this.crossMark.setAttribute('visible', 'false');
                    if (!this.isFloorDetected && appState === 'INITIALIZING') {
                        instructionText.style.display = 'block';
                        startDotAnimation();
                    }
                    this.el.sceneEl.emit('placeability-changed', { isPlaceable: false });
                }
            },
        
            updateReticleAndCrossMarkVisibility: function () {
                const currentScene = this.el.sceneEl;
                if (!currentScene.is('ar-mode')) return;
        
                if (appState === 'PLACING' || appState === 'EDITING') {
                    if (this.isFloorDetected && isEditMode) {
                        // isCurrentlyPlaceableはtickで計算されるので、ここではUI要素の表示/非表示のみを制御
                        // tickで位置と可否を判断して、最終的なvisibleが設定される
                    } else {
                        this.reticle.setAttribute('visible', 'false');
                        this.crossMark.setAttribute('visible', 'false');
                    }
                } else { // IDLE, INITIALIZING
                    this.reticle.setAttribute('visible', 'false');
                    this.crossMark.setAttribute('visible', 'false');
                }
            }
        });
        
        
        // 家具の追加、選択、削除、モード管理を行うコンポーネント
        AFRAME.registerComponent('furniture-manager', {
            init: function () {
                this.scene = this.el.sceneEl;
                this.placedObjects = [];
                this.previewObject = null;
                this.selectedObject = null;
                this.hoveredObject = null; // Three.jsのhoveredObjectに相当
                this.isDraggingSlider = false;
                this.isRotatingContinuously = false;
                this.continuousRotationDirection = 0;
                this.objectPendingDeletion = null;
                this.floorY = null; // ar-hit-test-managerから受け取る床のY座標
                this.isPlaceable = false; // 現在の場所が配置可能かどうか
        
                this.setupHtmlListeners();
        
                // Three.js版の名残だが使われていない
                // this.scene.addEventListener('ar-hit-test-found', this.onHitTestFound.bind(this));
                this.scene.addEventListener('enter-vr', this.onEnterVR.bind(this));
                this.scene.addEventListener('exit-vr', this.onExitVR.bind(this));
                this.scene.addEventListener('placeability-changed', (event) => {
                    this.isPlaceable = event.detail.isPlaceable;
                    updateUI(); // UI更新をトリガー
                });
                this.scene.addEventListener('floor-detected', (event) => {
                    this.floorY = event.detail.floorY;
                });
        
                // gltf-modelがロードされたときに、初期スケールを userData に保存するリスナー
                this.el.sceneEl.addEventListener('model-loaded', (e) => {
                    const model = e.detail.model;
                    const entity = e.target;
                    // gltf-modelコンポーネントがアタッチされているエンティティが対象
                    if (entity.components['gltf-model']) {
                        const initialBox = new AFRAME.THREE.Box3().setFromObject(model);
                        const size = initialBox.getSize(new AFRAME.THREE.Vector3());
        
                        // ロードされたモデルが previewObject または selectedObject の場合のみ処理
                        if (entity === this.previewObject || entity === this.selectedObject) {
                            // 元のコードのheightに基づいてスケールを計算し適用
                            const data = entity.userData.furnitureData;
                            if (data && data.height) {
                                const scaleFactor = data.height / size.y;
                                entity.object3D.scale.set(scaleFactor, scaleFactor, scaleFactor);
                                entity.object3D.userData.initialScale = entity.object3D.scale.clone(); // THREE.Vector3のクローンを保存
                                entity.object3D.userData.scaleMultiplier = 1.0;
                                updateSliderForObject(entity.object3D); // スライダーを初期状態に設定
                            }
                            // Three.jsのオブジェクトに直接設定する場合
                            entity.object3D.userData.initialScale = entity.object3D.scale.clone();
                            entity.object3D.userData.scaleMultiplier = 1.0;
                        }
        
                        // すべてのモデルのサブメッシュに透明度プロパティを設定
                        model.traverse((child) => {
                            if (child.isMesh && child.material) {
                                child.material.transparent = true; // 透明度を有効にする
                                child.material.opacity = 1.0; // デフォルトは不透明
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                });
            },
        
            onEnterVR: function () {
                appState = 'IDLE';
                updateUI();
            },
        
            onExitVR: function () {
                this.resetScene();
                appState = 'INITIALIZING';
                updateUI();
            },
        
            resetScene: function () {
                this.placedObjects.forEach(obj => obj.parentNode.removeChild(obj));
                this.placedObjects = [];
                if (this.previewObject) {
                    this.previewObject.parentNode.removeChild(this.previewObject);
                    this.previewObject = null;
                }
                this.selectedObject = null;
                this.hoveredObject = null;
                this.objectPendingDeletion = null;
            },
        
            onAddFurnitureClick: function (e) {
                e.stopPropagation();
                if (appState === 'IDLE') {
                    furnitureModal.style.display = 'flex';
                    populateCategories();
                    displayFurniture(allCategories[currentCategoryIndex]);
                    searchInput.focus();
                }
            },
        
            onEditFurnitureClick: function (e) {
                e.stopPropagation();
                this.selectAndEditObject(this.hoveredObject);
            },
        
            onDeleteClick: function (e) {
                e.stopPropagation();
                const targetObject = this.selectedObject || this.previewObject;
                if (targetObject) {
                    this.showConfirmDialog(targetObject);
                }
            },
        
            onConfirmClick: function (e) {
                e.stopPropagation();
                if (appState === 'PLACING') {
                    this.placeObject();
                } else if (appState === 'EDITING') {
                    this.finishEditing();
                }
            },
        
            onRotateClick: function (e, direction) {
                e.stopPropagation();
                const target = this.previewObject || this.selectedObject;
                if (target && target.object3D) {
                    target.object3D.rotation.y += (Math.PI / 4) * direction;
                }
            },
        
            startContinuousRotation: function (direction) {
                this.isRotatingContinuously = true;
                this.continuousRotationDirection = direction;
            },
        
            stopContinuousRotation: function () {
                this.isRotatingContinuously = false;
                this.continuousRotationDirection = 0;
            },
        
            setupHtmlListeners: function () {
                addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 32px; height: 32px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>`;
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`;
                confirmButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>`;
                rotateLeftButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>`;
                rotateRightButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3" /></svg>`;
        
                addButton.addEventListener('click', this.onAddFurnitureClick.bind(this));
                editButton.addEventListener('click', this.onEditFurnitureClick.bind(this));
                deleteButton.addEventListener('click', this.onDeleteClick.bind(this));
                confirmButton.addEventListener('click', this.onConfirmClick.bind(this));
        
                // 回転ボタンの長押しイベント
                const setupRotationButtonEvents = (button, direction) => {
                    let pressTimer = null;
                    const pressStart = (e) => {
                        e.preventDefault();
                        pressTimer = setTimeout(() => {
                            this.startContinuousRotation(direction);
                        }, 300);
                    };
                    const pressEnd = () => {
                        clearTimeout(pressTimer);
                        if (!this.isRotatingContinuously) {
                            // 短押しの場合のみ onRotateClick を呼び出す
                            // ここで event オブジェクトを渡すのは少し不自然だが、
                            // 元のコードの onRotateClick の引数に合わせる
                            this.onRotateClick(event, direction);
                        }
                        this.stopContinuousRotation();
                    };
                    button.addEventListener('mousedown', pressStart);
                    button.addEventListener('touchstart', pressStart, { passive: false });
                    button.addEventListener('mouseup', pressEnd);
                    button.addEventListener('touchend', pressEnd);
                    button.addEventListener('mouseleave', pressEnd);
                };
                setupRotationButtonEvents(rotateLeftButton, 1);
                setupRotationButtonEvents(rotateRightButton, -1);
        
                // スライダーイベント
                let isDraggingSlider = false;
                const onSliderDragStart = (e) => { e.stopPropagation(); isDraggingSlider = true; };
                const onSliderDragEnd = () => isDraggingSlider = false;
                const onSliderDragMove = (event) => {
                    if (!isDraggingSlider) return;
                    event.preventDefault();
                    const clientX = event.clientX || event.touches[0].clientX;
                    const rect = sliderTrack.getBoundingClientRect();
                    let percent = (clientX - rect.left) / rect.width;
                    percent = Math.max(0, Math.min(1, percent));
                    this.updateScaleFromSlider(percent);
                };
        
                sliderHandle.addEventListener('mousedown', onSliderDragStart);
                document.addEventListener('mousemove', onSliderDragMove);
                document.addEventListener('mouseup', onSliderDragEnd);
                sliderHandle.addEventListener('touchstart', onSliderDragStart, { passive: false });
                document.addEventListener('touchmove', onSliderDragMove, { passive: false });
                document.addEventListener('touchend', onSliderDragEnd);
        
                // モード切り替えボタン
                modeSwitchButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (appState === 'PLACING' || appState === 'EDITING') {
                        return;
                    }
                    isEditMode = !isEditMode;
                    this.scene.emit('is-edit-mode-changed', { isEditMode: isEditMode });
                    if (!isEditMode) {
                        this.finishEditing(); // 鑑賞モードに切り替える際、編集中のオブジェクトがあれば確定
                    }
                    updateUI();
                });
        
                // ヘルプモーダル
                helpButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    helpModal.style.display = 'flex';
                });
                closeHelpButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    helpModal.style.display = 'none';
                });
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        helpModal.style.display = 'none';
                    }
                });
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const targetTab = button.dataset.tab;
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        helpPages.forEach(page => {
                            page.classList.toggle('active', page.id === targetTab);
                        });
                    });
                });
        
                // 削除確認ダイアログ
                confirmDeleteYes.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (this.objectPendingDeletion) {
                        this.deleteObject(this.objectPendingDeletion);
                    }
                    confirmDialog.style.display = 'none';
                    this.objectPendingDeletion = null;
                });
                confirmDeleteNo.addEventListener('click', (e) => {
                    e.stopPropagation();
                    confirmDialog.style.display = 'none';
                    this.objectPendingDeletion = null;
                });
        
                // 家具選択モーダル
                closeModalButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    furnitureModal.style.display = 'none';
                    searchInput.blur();
                    adjustModalForKeyboard(); // モーダル位置をリセット
                });
                furnitureModal.addEventListener('click', (e) => {
                    if (e.target === furnitureModal) {
                        e.stopPropagation();
                        furnitureModal.style.display = 'none';
                        searchInput.blur();
                        adjustModalForKeyboard(); // モーダル位置をリセット
                    }
                });
        
                // 検索機能
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    const activeCategory = document.querySelector('.category-tab-button.active')?.dataset.category || 'すべて';
                    displayFurniture(activeCategory, searchTerm);
                    clearSearchButton.style.display = searchTerm.length > 0 ? 'block' : 'none';
                });
                clearSearchButton.addEventListener('click', () => {
                    searchInput.value = '';
                    clearSearchButton.style.display = 'none';
                    const activeCategory = document.querySelector('.category-tab-button.active')?.dataset.category || 'すべて';
                    displayFurniture(activeCategory);
                    searchInput.focus();
                });
        
                // 家具モーダルのスワイプジェスチャー
                let touchStartX = 0;
                let touchEndX = 0;
                const swipeThreshold = 50;
        
                modalContent.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.category-tab-button') || e.target.closest('#close-modal-button') || e.target.closest('#search-input') || e.target.closest('.grid-item')) {
                        return;
                    }
                    touchStartX = e.changedTouches[0].clientX;
                }, { passive: true });
        
                modalContent.addEventListener('touchend', (e) => {
                    if (e.target.closest('.category-tab-button') || e.target.closest('#close-modal-button') || e.target.closest('#search-input') || e.target.closest('.grid-item')) {
                        return;
                    }
                    touchEndX = e.changedTouches[0].clientX;
                    this.handleSwipeGesture();
                }, { passive: true });
        
                exitArButton.addEventListener('click', () => this.scene.exitVR());
            },
        
            handleSwipeGesture: function () {
                const swipeDistance = touchEndX - touchStartX;
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance < 0) { // 左スワイプ（次のカテゴリへ）
                        currentCategoryIndex++;
                        if (currentCategoryIndex >= allCategories.length) {
                            currentCategoryIndex = 0;
                        }
                    } else { // 右スワイプ（前のカテゴリへ）
                        currentCategoryIndex--;
                        if (currentCategoryIndex < 0) {
                            currentCategoryIndex = allCategories.length - 1;
                        }
                    }
                    const newCategory = allCategories[currentCategoryIndex];
                    activateCategoryTab(newCategory);
                    displayFurniture(newCategory, searchInput.value);
                }
            },
        
            // Three.jsオブジェクトの透明度設定
            setObjectTransparency: function (object3D, isTransparent, opacity = 0.7) {
                if (!object3D) return;
                object3D.traverse(child => {
                    if (child.isMesh) {
                        child.material.transparent = true;
                        child.material.opacity = isTransparent ? opacity : 1.0;
                        child.material.needsUpdate = true;
                    }
                });
            },
        
            // Three.jsでいうRaycasterの代わりに、A-FrameのCursor/Raycasterシステムを利用
            // tickごとにホーバー状態をチェック
            tick: function () {
                if (!isEditMode || appState !== 'IDLE') {
                    if (this.hoveredObject) {
                        this.setObjectTransparency(this.hoveredObject.object3D, false);
                        this.hoveredObject = null;
                        updateUI();
                    }
                    return;
                }
        
                // カメラの正面方向でIntersectionをチェック
                const intersection = this.camera.components.raycaster.intersections[0];
                let newHoveredObject = null;
        
                if (intersection && intersection.object && intersection.object.el) {
                    // 交差したオブジェクトのA-Frameエンティティを取得
                    let intersectedEntity = intersection.object.el;
        
                    // 階層を遡って placedObjects に含まれる親エンティティを探す
                    while (intersectedEntity && !this.placedObjects.includes(intersectedEntity)) {
                        if (intersectedEntity.parentNode.tagName.toLowerCase() === 'a-scene') {
                            intersectedEntity = null; // シーンの直下まで遡ったら終了
                            break;
                        }
                        intersectedEntity = intersectedEntity.parentNode;
                    }
        
                    if (intersectedEntity && this.placedObjects.includes(intersectedEntity)) {
                        newHoveredObject = intersectedEntity;
                    }
                }
        
                if (newHoveredObject !== this.hoveredObject) {
                    if (this.hoveredObject && this.hoveredObject !== this.selectedObject) {
                        this.setObjectTransparency(this.hoveredObject.object3D, false);
                    }
                    if (newHoveredObject && newHoveredObject !== this.selectedObject) {
                        this.setObjectTransparency(newHoveredObject.object3D, true);
                    }
                    this.hoveredObject = newHoveredObject;
                    updateUI(); // UIの表示/非表示を更新
                }
        
                // 連続回転の処理
                if (this.isRotatingContinuously && (appState === 'PLACING' || appState === 'EDITING')) {
                    const target = this.previewObject || this.selectedObject;
                    if (target && target.object3D) {
                        const rotationSpeed = 0.04;
                        target.object3D.rotation.y += rotationSpeed * this.continuousRotationDirection;
                    }
                }
        
                // 削除アニメーションの更新
                const currentTime = this.el.sceneEl.time / 1000; // A-Frameのtimeはミリ秒
                for (let i = objectsToDelete.length - 1; i >= 0; i--) {
                    const item = objectsToDelete[i];
                    const progress = (currentTime - item.startTime) / item.duration;
        
                    if (progress < 1) {
                        // オブジェクトのY位置と透明度を更新
                        item.object.object3D.position.y = item.initialY + progress * 0.5;
                        const opacity = 1.0 - progress;
                        this.setObjectTransparency(item.object.object3D, true, opacity);
                    } else {
                        // アニメーション終了後、シーンから削除
                        if (item.object.parentNode) {
                            item.object.parentNode.removeChild(item.object);
                        }
                        objectsToDelete.splice(i, 1);
                    }
                }
        
                // UIの確定ボタンの活性状態を更新
                confirmButton.disabled = !this.isPlaceable;
            },
        
            // 新しい家具を配置
            spawnPreviewObject: function () {
                if (this.previewObject) {
                    this.previewObject.parentNode.removeChild(this.previewObject);
                    this.previewObject = null;
                }
                if (!selectedFurnitureData) return;
        
                this.previewObject = document.createElement('a-entity');
                this.previewObject.setAttribute('gltf-model', `#${selectedFurnitureData.file.replace('.glb', '-model')}`);
                this.previewObject.setAttribute('visible', 'false'); // ヒットテストで見つかるまで非表示
                this.previewObject.classList.add('collidable'); // レイキャスト対象に追加
                this.previewObject.userData.furnitureData = selectedFurnitureData; // 家具データをuserDataに保存
        
                this.previewObject.addEventListener('model-loaded', () => {
                    this.setObjectTransparency(this.previewObject.object3D, true); // ロード後に透明にする
                    updateSliderForObject(this.previewObject.object3D); // スライダーを初期状態に設定
                });
        
                this.scene.appendChild(this.previewObject);
                appState = 'PLACING';
                updateUI();
            },
        
            placeObject: function () {
                if (!this.previewObject) return;
        
                // プレビューオブジェクトのデータを引き継ぎ、透明度を解除
                this.setObjectTransparency(this.previewObject.object3D, false);
        
                // previewObjectをそのままplacedObjectsに移動させる
                this.placedObjects.push(this.previewObject);
        
                // previewObjectをクリア
                this.previewObject = null;
                appState = 'IDLE';
                updateUI();
            },
        
            selectAndEditObject: function (objectToEdit) {
                if (!isEditMode || appState !== 'IDLE' || !objectToEdit) return;
        
                if (this.selectedObject) {
                    this.setObjectTransparency(this.selectedObject.object3D, false);
                }
                this.selectedObject = objectToEdit;
                this.setObjectTransparency(this.selectedObject.object3D, true); // 選択されたオブジェクトを透明にする
        
                if (this.hoveredObject === this.selectedObject) {
                    this.hoveredObject = null; // ホバー状態を解除
                }
        
                appState = 'EDITING';
                updateUI();
                updateSliderForObject(this.selectedObject.object3D); // スライダーを更新
            },
        
            finishEditing: function () {
                if (!this.selectedObject) return;
                this.setObjectTransparency(this.selectedObject.object3D, false);
                this.selectedObject = null;
                appState = 'IDLE';
                updateUI();
            },
        
            showConfirmDialog: function (object) {
                this.objectPendingDeletion = object;
                confirmDialog.style.display = 'flex';
            },
        
            deleteObject: function (objectToDelete) {
                if (!objectToDelete) return;
        
                const indexInPlaced = this.placedObjects.indexOf(objectToDelete);
                if (indexInPlaced > -1) {
                    this.placedObjects.splice(indexInPlaced, 1);
                }
        
                // 削除アニメーションの追加
                objectsToDelete.push({
                    object: objectToDelete,
                    startTime: this.el.sceneEl.time / 1000,
                    duration: 0.3,
                    initialY: objectToDelete.object3D.position.y
                });
        
                if (objectToDelete === this.selectedObject) {
                    this.selectedObject = null;
                    appState = 'IDLE';
                    updateUI();
                } else if (objectToDelete === this.previewObject) {
                    this.previewObject = null;
                    appState = 'IDLE';
                    updateUI();
                }
            },
        
            updateScaleFromSlider: function (percent) {
                const activeObject = (appState === 'PLACING') ? this.previewObject : this.selectedObject;
                if (!activeObject || !activeObject.object3D) return;
        
                const multiplier = 0.5 + percent * 1.5; // 0.5倍から2.0倍の範囲
                activeObject.object3D.userData.scaleMultiplier = multiplier;
        
                const initialScale = activeObject.object3D.userData.initialScale || new AFRAME.THREE.Vector3(1, 1, 1);
                activeObject.object3D.scale.copy(initialScale).multiplyScalar(multiplier);
        
                updateSliderHandlePosition(percent);
            }
        });
        
        // 削除対象オブジェクトのリスト（アニメーション用）
        const objectsToDelete = [];
        
        
        // UI更新関数 (JavaScriptのみでUIを制御)
        function updateUI() {
            // ARボタンはA-Frameが自動で生成するため、ここでは制御しない
            // タイトルコンテナはARセッション開始時に非表示、終了時に表示
            if (AFRAME.scenes[0] && AFRAME.scenes[0].is('ar-mode')) {
                titleContainer.style.display = 'none';
                exitArButton.style.display = 'flex';
                helpButton.style.display = 'flex';
                modeSwitchButton.style.display = 'flex';
            } else {
                titleContainer.style.display = 'block';
                exitArButton.style.display = 'none';
                helpButton.style.display = 'none';
                modeSwitchButton.style.display = 'none';
            }
        
            // モード切り替えボタンの見た目
            if (isEditMode) {
                editModeLabel.classList.add('active');
                viewModeLabel.classList.remove('active');
            } else {
                editModeLabel.classList.remove('active');
                viewModeLabel.classList.add('active');
            }
        
            // モード切り替えボタンの活性状態
            if (appState === 'PLACING' || appState === 'EDITING') {
                modeSwitchButton.style.opacity = '0.5';
                modeSwitchButton.style.cursor = 'not-allowed';
            } else {
                modeSwitchButton.style.opacity = '1';
                modeSwitchButton.style.cursor = 'pointer';
            }
        
            // その他のUI要素の表示/非表示
            addButton.style.display = 'none';
            editButton.style.display = 'none';
            transformControls.style.display = 'none';
            decisionControls.style.display = 'none';
        
            const furnitureManager = document.querySelector('a-scene').components['furniture-manager'];
        
            if (isEditMode) {
                switch (appState) {
                    case 'IDLE':
                        addButton.style.display = furnitureManager.isFloorDetected ? 'flex' : 'none';
                        if (furnitureManager.hoveredObject) {
                            editButton.style.display = 'flex';
                        }
                        break;
                    case 'PLACING':
                    case 'EDITING':
                        transformControls.style.display = 'flex';
                        decisionControls.style.display = 'flex';
                        confirmButton.disabled = !furnitureManager.isPlaceable; // 配置可否に基づいて確定ボタンを制御
                        break;
                }
            }
        }
        
        // --- 家具選択モーダル関連の関数 ---
        
        function updateAllCategories() {
            allCategories = [...new Set(furnitureData.map(item => item.category))].sort();
            allCategories.unshift('すべて');
        }
        
        function populateCategories() {
            categoryTabsContainer.innerHTML = '';
            updateAllCategories();
        
            allCategories.forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.className = 'category-tab-button';
                tabButton.textContent = category;
                tabButton.dataset.category = category;
        
                tabButton.addEventListener('click', () => {
                    searchInput.value = '';
                    clearSearchButton.style.display = 'none';
                    document.querySelectorAll('.category-tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    tabButton.classList.add('active');
                    currentCategoryIndex = allCategories.indexOf(category);
                    displayFurniture(category);
                });
                categoryTabsContainer.appendChild(tabButton);
            });
            activateCategoryTab(allCategories[currentCategoryIndex]);
        }
        
        function displayFurniture(category, searchTerm = '') {
            furnitureGrid.innerHTML = '';
        
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
        
            const filteredFurniture = furnitureData.filter(item => {
                const matchesCategory = (category === 'すべて' || item.category === category);
                const matchesSearch = item.name.toLowerCase().includes(lowerCaseSearchTerm);
                return matchesCategory && matchesSearch;
            });
        
            if (filteredFurniture.length === 0) {
                furnitureGrid.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">家具が見つかりませんでした。</p>';
            } else {
                filteredFurniture.forEach(item => {
                    const gridItem = document.createElement('div');
                    gridItem.className = 'grid-item';
                    gridItem.dataset.category = item.category;
        
                    const img = document.createElement('img');
                    img.src = item.thumbnail;
                    img.alt = item.name;
                    img.onerror = () => { img.style.display = 'none'; console.warn(`Thumbnail not found or failed to load: ${item.thumbnail}`); };
                    gridItem.appendChild(img);
        
                    const p = document.createElement('p');
                    p.textContent = item.name;
                    gridItem.appendChild(p);
        
                    gridItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectedFurnitureData = item; // 選択された家具データを設定
                        document.querySelector('a-scene').components['furniture-manager'].spawnPreviewObject(); // プレビューオブジェクトを生成
                        furnitureModal.style.display = 'none';
                        updateUI();
                    });
                    furnitureGrid.appendChild(gridItem);
                });
            }
        }
        
        function activateCategoryTab(categoryToActivate) {
            document.querySelectorAll('.category-tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === categoryToActivate) {
                    btn.classList.add('active');
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            });
        }
        
        // キーボードの表示/非表示を検知してモーダル位置を調整する
        let initialViewportHeight = window.innerHeight;
        let currentKeyboardHeight = 0;
        
        function adjustModalForKeyboard() {
            const newViewportHeight = window.innerHeight;
            currentKeyboardHeight = initialViewportHeight - newViewportHeight;
        
            if (currentKeyboardHeight > 50) {
                furnitureModal.classList.add('modal-above-keyboard');
                furnitureModal.style.setProperty('--keyboard-height', `${currentKeyboardHeight}px`);
            } else {
                furnitureModal.classList.remove('modal-above-keyboard');
                furnitureModal.style.removeProperty('--keyboard-height');
            }
        }
        window.addEventListener('resize', adjustModalForKeyboard);
        
        
        // スライダーの制御
        function updateSliderHandlePosition(percent) {
            const handleWidth = sliderHandle.offsetWidth;
            const trackWidth = sliderTrack.offsetWidth;
            sliderHandle.style.left = `calc(${percent * 100}% - ${handleWidth * percent}px)`;
        
            const scale = 0.8 + 0.4 * percent;
            sliderHandle.style.transform = `translateY(-50%) scale(${scale})`;
        }
        
        function updateSliderForObject(object3D) {
            if (!object3D) return;
            const multiplier = object3D.userData.scaleMultiplier || 1.0;
            const percent = (multiplier - 0.5) / 1.5;
            updateSliderHandlePosition(percent);
        }
        
        // ドットアニメーション
        function startDotAnimation() {
            if (dotAnimationTimer) return;
            let dotCount = 0;
            const dots = ['・', '・・', '・・・'];
            dotAnimationTimer = setInterval(() => {
                loadingDots.textContent = dots[dotCount % dots.length];
                dotCount++;
            }, 400);
        }
        
        function stopDotAnimation() {
            if (dotAnimationTimer) {
                clearInterval(dotAnimationTimer);
                dotAnimationTimer = null;
                loadingDots.textContent = ''; // アニメーション停止時にドットをクリア
            }
        }
        
        // A-Frameシーンが完全にロードされたら初期UI更新
        document.querySelector('a-scene').addEventListener('loaded', () => {
            updateUI();
        });

    </script>
</body>
</html>
